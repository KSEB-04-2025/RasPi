# cam.py - 자동 품질 검사 컨트롤러

## 1. 개요

`cam.py`는 아두이노(Arduino)와 연동하여 카메라를 제어하고, 촬영된 이미지를 AI 서버로 전송하여 제품의 결함 및 등급을 판정하는 자동화 시스템의 메인 컨트롤러 스크립트입니다.

두 개의 카메라(일반, 현미경)를 사용하여 각기 다른 검사 단계(결함 검사, 등급 판정)를 수행하며, 모든 촬영 이미지는 Google Cloud Storage(GCS)에 자동으로 백업됩니다. 또한, 시스템의 주요 구성 요소(카메라, 서버) 상태를 주기적으로 점검하여 프론트엔드 서버로 전송하는 헬스체크 기능이 포함되어 있습니다.

## 2. 주요 기능

- **아두이노 연동**: 시리얼 통신을 통해 아두이노로부터 `SNAP1`, `SNAP2` 신호를 수신하여 각 검사 프로세스를 트리거합니다.
- **결함 검사 (SNAP1)**: 일반 카메라로 제품 이미지를 촬영하고, AI 서버에 전송하여 결함 여부("X" 또는 "정상")를 판별합니다.
- **등급 판정 (SNAP2)**: 현미경 카메라로 제품 이미지를 촬영하고, Rule-based 서버에 전송하여 최종 등급을 판정합니다.
- **Google Cloud Storage 연동**: 촬영된 모든 원본 이미지를 GCS 버킷에 업로드하여 데이터 관리 및 추적을 용이하게 합니다.
- **헬스체크**: 카메라 및 AI 서버의 상태를 주기적으로 확인하고, 결과를 프론트엔드 API로 전송하여 시스템 모니터링을 지원합니다.

## 3. 시스템 워크플로우

### 3.1. 결함 검사 (SNAP1)

1. 아두이노가 시리얼로 `SNAP1` 신호를 전송합니다.
2. 스크립트는 일반 카메라(`CAM_IR1`)로 이미지를 촬영합니다.
3. 촬영된 이미지를 GCS의 `raw_defect` 폴더에 업로드합니다.
4. 이미지를 결함 판단 AI 서버(`URL_SNAP1`)로 전송합니다.
5. 서버로부터 `{"label": "X"}` 와 같이 결함 결과를 수신하면 아두이노에 `X` 신호를, 정상이면 `GO` 신호를 보냅니다.

### 3.2. 등급 판정 (SNAP2)

1. 아두이노가 시리얼로 `SNAP2` 신호를 전송합니다.
2. 스크립트는 현미경 카메라(`CAM_IR2`)로 이미지를 촬영합니다.
3. 촬영된 이미지를 GCS의 `raw_grade` 폴더에 업로드합니다.
4. 이미지를 등급 판단 서버(`URL_SNAP2`)로 전송합니다.
5. 서버로부터 `{"label": "A"}` 와 같은 등급을 수신하면 아두이노에 `RESULT:A` 형식으로 신호를 보냅니다.

## 4. 설정 및 구성

스크립트 상단의 설정 변수들을 통해 주요 파라미터를 변경할 수 있습니다.

- `PORT`: 아두이노와 연결된 시리얼 포트 (예: `/dev/ttyACM0`)
- `BAUD`: 시리얼 통신 속도 (기본값: 9600)
- `SNAP1_KEYWORD`, `SNAP2_KEYWORD`: 각 프로세스를 트리거하는 아두이노 신호
- `URL_SNAP1`, `URL_SNAP2`: 결함 및 등급 판정 서버의 API 주소
- `GCS_KEY_PATH`: Google Cloud Platform 서비스 계정 키 파일 경로 (`service-account.json`)
- `BUCKET_NAME`: 이미지를 저장할 GCS 버킷 이름
- `CAM_IR1`, `CAM_IR2`: 결함 및 등급 검사용 카메라의 인덱스 번호
- `RESOLUTION`: 카메라 캡처 해상도
- `FRONT_HEALTHCHECK_URL`: 헬스체크 결과를 수신할 프론트엔드 API 주소

## 5. 사전 준비 사항

### 5.1. 하드웨어

- 아두이노 보드
- 2개의 카메라 (일반, 현미경)
- 조명 및 기타 검사 장비

### 5.2. 소프트웨어

- **Python 3**
- **필수 라이브러리 설치**:
  ```bash
  pip install pyserial requests opencv-python google-cloud-storage
  ```
- **GCP 인증**:
  - `GCS_KEY_PATH`에 지정된 경로에 유효한 `service-account.json` 파일을 위치시켜야 합니다.

## 6. 실행 방법

1. 필요한 하드웨어를 모두 연결합니다.
2. 스크립트 상단의 설정 변수들이 올바른지 확인합니다.
3. 터미널에서 다음 명령어를 실행하여 스크립트를 시작합니다.

   ```bash
   python cam.py
   ```

4. 스크립트가 실행되면 시리얼 포트 연결, 헬스체크 시작 등의 로그가 출력되며 아두이노로부터 신호를 대기합니다.
